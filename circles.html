<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circles</title>
    <link rel="stylesheet" href="styling.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Red badge for notification and message count (Consistent with Dashboard) */
        .badge {
            position: absolute;
            top: 0;
            right: 0;
            transform: translate(50%, -50%);
            background-color: #ef4444; /* Tailwind red-500 */
            color: white;
            border-radius: 9999px;
            width: 1.25rem; /* Slightly larger for numbers up to 99 */
            height: 1.25rem; /* Keep it square for perfect circle */
            font-size: 0.75rem; /* Smaller font for number */
            display: flex; /* Use flexbox for centering text inside */
            align-items: center;
            justify-content: center;
            font-weight: 700; /* Bold number */
            user-select: none; /* Prevent text selection */
            padding: 0.1rem; /* Small padding inside for numbers >= 10 */
            min-width: 1.25rem; /* Ensure minimum width for 1-digit numbers */
            box-sizing: border-box; /* Include padding in width/height */
            z-index: 10; /* Ensure badge is above link text */
        }

        /* Profile dropdown - CORRECTED POSITIONING (Consistent with Dashboard) */
        #profileDropdown {
            display: none;
            position: absolute;
            top: calc(100% + 0.5rem); /* Position below the button with 0.5rem gap */
            left: 0; /* Align to the left edge of the profile link */
            right: auto; /* Ensure it doesn't try to align right AND left */
            
            margin-top: 0;
            width: 10rem;
            background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
                        0 4px 6px -4px rgb(0 0 0 / 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1050;
        }

        #profileDropdown a {
            display: block;
            padding: 0.5rem 1rem;
            color: #374151; /* gray-700 */
            text-decoration: none;
        }

        #profileDropdown a:hover {
            background-color: #f3f4f6; /* gray-100 */
        }

        /* Layout flex for sidebar and main (Consistent with Dashboard) */
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f3f4f6;
            margin: 0;
        }

        /* Sidebar - MODIFIED FOR FIXED POSITIONING AND FLEX CONTAINER (Consistent with Dashboard) */
        .sidebar {
            background-color: white;
            min-width: 12rem;
            width: 12rem;
            padding: 2rem 1rem;
            box-shadow: 2px 0 6px rgb(0 0 0 / 0.1);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Allow the main navigation list to take up available space */
        }

        .sidebar ul li {
            margin-bottom: 1.25rem;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #374151; /* Tailwind gray-700 */
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
        }

        .sidebar ul li.active a {
            font-weight: 700;
            color: #1e40af; /* Tailwind blue-900 */
        }

        /* Styles for the bottom navigation group (Consistent with Dashboard) */
        .sidebar-bottom-nav {
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
            margin-top: 1.5rem;
            list-style: none;
            padding-left: 0;
            margin-bottom: 0;
        }

        .sidebar-bottom-nav li {
            margin-bottom: 1rem;
            position: relative; /* Needed for badge positioning within the list item */
        }

        .sidebar-bottom-nav li:last-child {
            margin-bottom: 0;
        }

        .sidebar-bottom-nav li a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #374151; /* Tailwind gray-700 */
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem; /* Decreased font size for bottom nav links */
            /* font-style: italic; REMOVED as per request */
            cursor: pointer;
            padding: 0.25rem 0; /* Add slight vertical padding */
            transition: color 0.2s ease; /* Smooth color transition on hover */
        }

        .sidebar-bottom-nav li a:hover {
            color: #1e40af; /* Tailwind blue-900 on hover */
        }

        .sidebar-bottom-nav li.active a {
            font-weight: 700;
            color: #1e40af;
        }

        /* Adjust icon within bottom nav links */
        .sidebar-bottom-nav li a .icon {
            font-size: 1.2rem; /* Slightly smaller icons for bottom nav */
        }

        /* Main content container - MODIFIED TO ACCOUNT FOR FIXED SIDEBAR (Consistent with Dashboard) */
        main.content {
            flex: 1;
            margin-left: 12rem; /* Add margin-left equal to sidebar width */
            padding: 2rem;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            min-height: 100vh;
        }

        /* Circle page specific styles - MODIFIED FOR CONSISTENCY */
        .header-controls { /* Consistent with dashboard top-bar naming */
            display: flex;
            flex-wrap: wrap;
            gap: 1rem; /* Slightly increased gap for consistency with dashboard */
            align-items: center;
            margin-bottom: 1rem;
            background-color: white; /* Consistent with dashboard top-bar */
            padding: 1rem; /* Consistent with dashboard top-bar */
            border-radius: 0.5rem; /* Consistent with dashboard top-bar */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Consistent with dashboard top-bar */
        }

        .header-controls button#addCircleButton { /* More specific selector */
            background-color: #1e40af; /* Tailwind blue-900 */
            color: white;
            padding: 0.75rem 1.5rem; /* Adjusted padding for consistency */
            border-radius: 0.375rem;
            font-size: 0.95rem; /* Adjusted font size for consistency */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            border: none;
        }

        .header-controls button#addCircleButton:hover {
            background-color: #1e3a8a; /* Tailwind blue-800 */
            transform: translateY(-1px); /* Subtle lift effect */
        }
        .header-controls button#addCircleButton:active {
            transform: translateY(0);
        }

        .header-controls input[type="text"] {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem; /* Adjusted padding for consistency */
            font-size: 0.95rem; /* Adjusted font size for consistency */
            outline: none;
            transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
            max-width: 300px; /* Limit max width like dashboard search */
        }

        .header-controls input[type="text"]:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }

        /* Table styling consistent with Dashboard panels */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            color: #374151;
            background-color: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Consistent shadow with panels */
            margin-top: 1.5rem; /* Adjusted margin */
        }

        table thead {
            background-color: #f9fafb;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
        }

        table th,
        table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }

        table tbody tr:last-child td {
            border-bottom: none; /* No border on the last row */
        }

        table tbody tr:hover {
            background-color: #f3f4f6;
        }

        /* Styles for action buttons within the table */
        .edit-btn, .copy-btn {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: background-color 0.2s ease-in-out;
            border: none;
            cursor: pointer;
            margin-right: 0.25rem;
        }
        /* Style for a 'Success' looking button */
        .manage-btn.success { /* Keep definition if class is still used elsewhere for status display */
            background-color: #10B981; /* Tailwind green-500 */
        }
        .manage-btn.success:hover {
            background-color: #059669; /* Tailwind green-600 */
        }


        .edit-btn:hover, .copy-btn:hover {
            background-color: #2563eb; /* Tailwind blue-700 */
        }

        /* Add New Circle Pop-up Styles (kept consistent) */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .add-circle-popup {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 25px;
            width: 90%;
            max-width: 800px; /* Slightly wider to accommodate new section */
            position: relative;
            animation: fadeIn 0.3s ease-out;
            max-height: 90vh; /* Limit height */
            overflow-y: auto; /* Allow scrolling */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .add-circle-popup .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .add-circle-popup .popup-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #374151;
            margin: 0;
        }

        .add-circle-popup .popup-header .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #6b7280;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .add-circle-popup .popup-header .close-btn:hover {
            color: #ef4444;
        }

        .add-circle-popup .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .add-circle-popup .form-group {
            flex: 1 1 calc(50% - 7.5px);
            min-width: 200px;
        }

        .add-circle-popup .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #4b5563;
            margin-bottom: 5px;
        }

        .add-circle-popup .form-group .input-wrapper {
            position: relative;
        }

        .add-circle-popup .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box;
            color: #374151;
            padding-left: 35px; /* Space for icon */
        }

        .add-circle-popup .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .add-circle-popup .form-group .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        .add-circle-popup .form-group input.date-input {
            padding-right: 35px; /* Space for calendar icon */
        }

        .add-circle-popup .form-group .calendar-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            cursor: pointer;
        }

        .add-circle-popup .amount-display {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4b5563;
            margin-top: 20px;
            text-align: right;
            padding-right: 10px;
        }

        .add-circle-popup .popup-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        .add-circle-popup .popup-buttons button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .add-circle-popup .popup-buttons .submit-btn {
            background-color: #3b82f6;
            color: white;
        }

        .add-circle-popup .popup-buttons .submit-btn:hover {
            background-color: #2563eb;
        }

        .add-circle-popup .popup-buttons .close-btn-bottom {
            background-color: #e5e7eb;
            color: #374151;
        }

        .add-circle-popup .popup-buttons .close-btn-bottom:hover {
            background-color: #d1d5db;
        }

        /* Styles for sponsored users section */
        .sponsored-users-section {
            border-top: 1px solid #e5e7eb;
            margin-top: 20px;
            padding-top: 20px;
        }

        .sponsored-users-section h4 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }

        .sponsored-users-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 250px; /* Increased height for history */
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9fafb;
        }

        .sponsored-user-item {
            display: flex;
            flex-direction: column; /* Changed to column for better layout with history */
            /* justify-content: space-between; Removed as now column flex */
            align-items: flex-start; /* Align left */
            padding: 8px 12px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: 0.9rem;
            color: #4b5563;
        }
        .sponsored-user-item .main-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 5px; /* Space between main info and progress details */
        }
        .sponsored-user-item .progress-info {
            flex-grow: 1;
            padding-right: 10px; /* Space from buttons */
        }
        .sponsored-user-item .progress-buttons {
            display: flex; /* Ensure buttons are in a row */
            flex-shrink: 0; /* Don't shrink buttons */
        }
        .sponsored-user-item .progress-buttons button {
            padding: 4px 8px;
            font-size: 0.75rem;
            margin-left: 5px;
            min-width: 80px; /* Ensure buttons have consistent width */
        }
        /* Specific colors for completion/invite buttons */
        .btn-complete { background-color: #22c55e; color: white; } /* green-500 */
        .btn-complete:hover { background-color: #16a34a; } /* green-600 */
        .btn-invite { background-color: #6366f1; color: white; } /* indigo-500 */
        .btn-invite:hover { background-color: #4f46e5; } /* indigo-600 */
        .btn-history-toggle {
            background-color: #a1a1aa; /* gray-400 */
            color: white;
            padding: 2px 6px;
            font-size: 0.7em;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .btn-history-toggle:hover {
            background-color: #71717a; /* gray-600 */
        }


        /* Styles for adding a sponsored user to the circle */
        .add-sponsored-user-control {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #e5e7eb;
        }
        .add-sponsored-user-control select {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
        }
        .add-sponsored-user-control button {
            background-color: #2563eb; /* blue-700 */
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
        }
        .add-sponsored-user-control button:hover {
            background-color: #1e40af; /* blue-900 */
        }

        /* History section styles */
        .history-section {
            width: 100%;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e5e7eb;
            font-size: 0.8em;
            color: #6b7280;
            display: none; /* Hidden by default */
        }
        .history-section h5 {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .history-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .history-section li {
            background-color: #f3f4f6;
            padding: 5px 8px;
            border-radius: 3px;
            margin-bottom: 3px;
            border: 1px solid #e5e7eb;
        }
        .history-section li:last-child {
            margin-bottom: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            /* Adjustments for fixed sidebar on small screens */
            .sidebar {
                position: static;
                width: 100%;
                min-width: auto;
                height: auto;
                box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
                padding: 1rem;
            }
            .sidebar ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 1rem;
                flex-grow: 0;
            }
            .sidebar ul li {
                margin-bottom: 0;
            }
            .sidebar ul li a {
                font-size: 0.9rem;
                gap: 0.25rem;
            }
            /* Bottom nav also becomes horizontal on mobile */
            .sidebar-bottom-nav {
                flex-direction: row;
                justify-content: center;
                gap: 1rem;
                margin-top: 1rem;
                border-top: none;
                padding-top: 0;
            }
            .sidebar-bottom-nav li {
                margin-bottom: 0;
            }

            main.content {
                margin-left: 0;
                padding: 1rem;
            }
            .header-controls input[type="text"] {
                max-width: none;
            }
            /* .dashboard-panel is not on this page, but media query structure is kept */
            .dashboard-panel {
                padding: 1.5rem;
            }

            .add-circle-popup {
                max-width: 95%; /* Adjust for very small screens */
            }
            .add-circle-popup .form-group {
                flex: 1 1 100%; /* Stack form groups vertically */
                min-width: auto;
            }
            .sponsored-user-item {
                flex-direction: column; /* Stack items vertically */
                align-items: flex-start;
                gap: 5px;
            }
            .sponsored-user-item .progress-buttons {
                width: 100%; /* Full width buttons */
                display: flex;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-logo mb-8 mt-2 text-center">
            <a href="dashboard.html">
                <img src="Images/logo.png" alt="UNOCIRCLE Logo" class="h-12 w-auto mx-auto object-contain">
            </a>
        </div>

        <ul>
            <li><a href="dashboard.html"><i class="icon">üèÅ</i><span>Dashboard</span></a></li>
            <li><a href="users.html"><i class="icon">üë§</i><span>Users</span></a></li>
            <li class="active"><a href="circles.html"><i class="icon">‚ö™</i><span>Circles</span></a></li>
            <li><a href="circle-tracker.html"><i class="icon">üìä</i><span>Circle Tracker</span></a></li>
            <li><a href="payments.html"><i class="icon">üíµ</i><span>Payments</span></a></li>
            <li><a href="admin_users.html"><i class="icon">üëë</i><span>Admin</span></a></li>
        </ul>

        <ul class="sidebar-bottom-nav">
            <li>
                <a href="messages.html" id="inboxIconContainer">
                    <i class="icon">‚úâÔ∏è</i><span>Messages</span>
                    <span class="badge" id="messageCount">0</span> </a>
            </li>
            <li>
                <a href="#" id="notificationBellAnchor">
                    <i class="icon">üîî</i><span>Notifications</span>
                    <span class="badge" id="notificationCount">0</span> </a>
            </li>
            <li id="profileMenuContainer">
                <a href="#" id="profileButton" aria-haspopup="true" aria-expanded="false" aria-controls="profileDropdown"><i class="icon">üë§</i><span>Profile</span></a>
                <div id="profileDropdown" role="menu" aria-label="Profile Options">
                    <a href="account.html" role="menuitem" tabindex="-1">My Account</a>
                    <a href="login.html" role="menuitem" tabindex="-1">Log Out</a>
                </div>
            </li>
        </ul>
    </div>
    
    <main class="content">
        <h1 class="text-2xl font-semibold text-gray-800 mb-6">Circles</h1>

        <div class="header-controls">
            <button id="addCircleButton">ADD CIRCLE</button>
            <input
                type="text"
                id="searchInput"
                placeholder="Search circles..."
                class="border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
            />
        </div>

        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full text-sm text-left text-gray-700">
                <thead class="bg-gray-50 text-xs uppercase tracking-wider text-gray-500 border-b">
                    <tr>
                        <th class="px-4 py-3">Actions</th>
                        <th class="px-4 py-3">Circle #</th>
                        <th class="px-4 py-3">Status</th>
                        <th class="px-4 py-3">Monthly</th>
                        <th class="px-4 py-3">Period</th>
                        <th class="px-4 py-3">Fee</th>
                        <th class="px-4 py-3">Start Date</th>
                        <th class="px-4 py-3">End Date</th>
                        <th class="px-4 py-3">Reserve Period</th>
                        <th class="px-4 py-3">Assigned Members</th>
                    </tr>
                </thead>
                <tbody id="circlesTableBody">
                    </tbody>
            </table>
        </div>
    </main>

    <div class="popup-overlay" id="addCirclePopupContainer">
        <div class="add-circle-popup">
            <div class="popup-header">
                <h3 id="circlePopupTitle">Add New Circle</h3>
                <button class="close-btn" onclick="closeCirclePopup()">√ó</button>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 1 1 100%;">
                    <label for="circleName">Circle Name (optional)</label>
                    <div class="input-wrapper">
                        <i class="input-icon">‚óè</i>
                        <input type="text" id="circleName" name="circleName" placeholder="Circle Name">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="monthlyInvestment">Monthly Investment*</label>
                    <div class="input-wrapper">
                        <i class="input-icon">¬£</i>
                        <input type="text" id="monthlyInvestment" name="monthlyInvestment" placeholder="100" value="100" onkeyup="calculateAmount()" onchange="calculateAmount()">
                    </div>
                </div>
                <div class="form-group">
                    <label for="participantsMonths">Period (Months/Participants)*</label>
                    <div class="input-wrapper">
                        <i class="input-icon">üë§</i>
                        <input type="text" id="participantsMonths" name="participantsMonths" placeholder="10" value="10" onkeyup="calculateAmount()" onchange="calculateAmount()">
                    </div>
                </div>
                <div class="form-group">
                    <label for="fee">Fee*</label>
                    <div class="input-wrapper">
                        <i class="input-icon">¬£</i>
                        <input type="text" id="fee" name="fee" placeholder="5">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="startingDate">Starting Date*</label>
                    <div class="input-wrapper">
                        <input type="text" id="startingDate" name="startingDate" placeholder="Jun 2025" class="date-input">
                        <i class="calendar-icon">üìÖ</i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="endingDate">Ending Date</label>
                    <div class="input-wrapper">
                        <input type="text" id="endingDate" name="endingDate" placeholder="Mar 2026" class="date-input">
                        <i class="calendar-icon">üìÖ</i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="reservePeriod">Reserve Period*</label>
                    <div class="input-wrapper">
                        <i class="input-icon">0</i>
                        <input type="text" id="reservePeriod" name="reservePeriod" placeholder="0" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="assignedMembers">Initial Assigned Members*</label>
                    <div class="input-wrapper">
                        <i class="input-icon">üë•</i>
                        <input type="number" id="assignedMembers" name="assignedMembers" placeholder="0" value="0" min="0">
                    </div>
                </div>
            </div>

            <div class="amount-display">
                Amount: <span id="calculatedAmount">¬£100 x 10 = ¬£1000</span>
            </div>

            <div class="sponsored-users-section" id="sponsoredUsersSection">
                <h4>Sponsored Users in this Circle:</h4>
                <div class="sponsored-users-list" id="sponsoredUsersList">
                    <p class="text-gray-500 text-sm">No sponsored users assigned yet.</p>
                </div>
                <div class="add-sponsored-user-control">
                    <select id="availableSponsoredUsersSelect">
                        <option value="">Select Sponsored User to Add</option>
                        </select>
                    <button id="addSponsoredUserToCircleBtn">Add to Circle</button>
                </div>
            </div>
            <div class="popup-buttons">
                <button class="submit-btn" id="submitCircleButton">SUBMIT</button>
                <button class="close-btn-bottom" onclick="closeCirclePopup()">CLOSE</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STORAGE AND INITIALIZATION ---
        // Mock User Data (from users.html context, ideally fetched or shared)
        // This is crucial for linking sponsored users to circles
        const MOCK_USERS_DATA = [
            { id: '001', name: 'Alice Smith', email: 'alice@example.com', role: 'Admin', status: 'Active' },
            { id: '002', name: 'Bob Johnson', email: 'bob@example.com', role: 'User', status: 'Inactive' },
            { id: '003', name: 'Charlie Brown', email: 'charlie@example.com', role: 'Sponsored User', status: 'Active' },
            { id: '004', name: 'Diana Prince', email: 'diana@example.com', role: 'User', status: 'Active' },
            { id: '005', name: 'Eve Adams', email: 'eve@example.com', role: 'Sponsored User', status: 'Inactive' },
            { id: '006', name: 'Frank White', email: 'frank@example.com', role: 'System Admin', status: 'Active' },
            { id: '007', name: 'Grace Lee', email: 'grace@example.com', role: 'Private User', status: 'Active' } // Added Grace Lee as a Private User for cross-page testing
        ];

        // Global state for edit mode
        let isEditingMode = false;
        let currentCircleBeingEdited = null; // Stores the actual circle object being edited
        let nextCircleId = 1; // Used for new circles
        
        // Main data array for circles
        let circlesData = []; 

        const LOCAL_STORAGE_KEY = 'circlesApp_circlesData';

        // --- Financial Constants ---
        const DONATION_PERCENTAGE_OF_MONTHLY_INVESTMENT = 0.10; // 10% of monthly investment per completion
        const LOCKED_SAVINGS_PERCENTAGE = 0.20; // 20% of net gifted amount (after donation)

        // --- NEW: Transaction Log Data and Persistence (Must match users.html for shared log) ---
        let transactionLog = []; // Global array for all transactions/activities
        const LOCAL_STORAGE_LOG_KEY = 'app_transactionLog'; // Separate key for the log

        // Mock Current User for logging purposes (adjust as needed for testing roles)
        const CURRENT_USER_ID = '001'; // Assuming Alice Smith is currently logged in
        const CURRENT_USER_NAME = 'Alice Smith'; // Or dynamically set based on role

        function loadTransactionLogFromLocalStorage() {
            const storedLog = localStorage.getItem(LOCAL_STORAGE_LOG_KEY);
            if (storedLog) {
                transactionLog = JSON.parse(storedLog);
            } else {
                transactionLog = []; // Empty log on first load
            }
        }

        function saveTransactionLogToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_LOG_KEY, JSON.stringify(transactionLog));
        }

        // Add Log Entry Function (Copied from users.html)
        function addLogEntry(type, description, details = {}) {
            const now = new Date();
            const timestamp = now.toISOString(); // ISO string for easy date comparison
            const readableDate = now.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' });
            const readableTime = now.toLocaleTimeString('en-GB');

            const entry = {
                timestamp: timestamp,
                date: readableDate,
                time: readableTime,
                type: type, // e.g., "User Created", "Circle Updated", "Payment Marked"
                description: description,
                actorId: CURRENT_USER_ID,
                actorName: CURRENT_USER_NAME,
                details: details // Any additional data relevant to the log
            };
            transactionLog.push(entry);
            saveTransactionLogToLocalStorage();
        }
        // --- END NEW TRANSACTION LOG FUNCTIONS ---


        // --- Local Storage Functions for Circles Data ---
        function loadCirclesFromLocalStorage() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedData) {
                circlesData = JSON.parse(storedData);
            } else {
                // Initial sample data if nothing in local storage
                circlesData = [
                    {
                        id: 18,
                        circleName: 'Initial Circle',
                        monthlyInvestment: 100,
                        participantsMonths: 10,
                        fee: 5,
                        startingDate: 'Apr 2025',
                        endingDate: 'Jan 2026',
                        reservePeriod: 0,
                        assignedMembersCount: 8,
                        status: 'active',
                        sponsoredUsers: [
                            { 
                                userId: '003', 
                                name: 'Charlie Brown', 
                                completions: 3, 
                                invitesCompleted: 1, 
                                requiredInvites: 2, 
                                notifiedCompletions: false, 
                                notifiedInvites: false,
                                totalGiftedAmount: 0, // Initialize
                                totalDonationDeducted: 0, // Initialize
                                totalLockedSavings: 0, // Initialize
                                totalCurrentAccount: 0, // Initialize
                                transactionHistory: [] // Initialize history
                            }
                        ]
                    }
                ];
                // For the initial sample data, calculate the financial state
                // This is a one-time calculation for demo purposes on first load
                // In a real system, these would be persisted from previous transactions
                circlesData.forEach(circle => {
                    circle.sponsoredUsers.forEach(sponsoredUser => {
                        // Re-calculate based on current completions for demo purposes
                        // This assumes past completions are being 'processed' now.
                        const tempCompletions = sponsoredUser.completions;
                        sponsoredUser.completions = 0; // Reset to 0 before re-processing
                        sponsoredUser.totalGiftedAmount = 0; // Reset totals
                        sponsoredUser.totalDonationDeducted = 0;
                        sponsoredUser.totalLockedSavings = 0;
                        sponsoredUser.totalCurrentAccount = 0;
                        sponsoredUser.transactionHistory = []; // Clear history
                        for (let i = 0; i < tempCompletions; i++) {
                            sponsoredUser.completions = i + 1; 
                            processCompletionFinancials(circle.id, sponsoredUser.userId, true); // Don't notify on initial load
                        }
                        sponsoredUser.completions = tempCompletions; // Set back to original
                    });
                });
                saveCirclesToLocalStorage(); // Save initial data
            }
        }

        function saveCirclesToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(circlesData));
        }

        // --- Helper to initialize the nextCircleId from existing circles ---
        function initializeNextCircleId() {
            let maxId = 0;
            if (circlesData.length > 0) {
                maxId = Math.max(...circlesData.map(circle => circle.id));
            }
            nextCircleId = maxId + 1;
        }

        // --- Get references to DOM elements ---
        const addCircleButton = document.getElementById('addCircleButton');
        const addCirclePopupContainer = document.getElementById('addCirclePopupContainer');
        const circlePopupTitle = document.getElementById('circlePopupTitle');
        const submitCircleButton = document.getElementById('submitCircleButton');

        // Form inputs
        const circleNameInput = document.getElementById('circleName');
        const monthlyInvestmentInput = document.getElementById('monthlyInvestment');
        const participantsMonthsInput = document.getElementById('participantsMonths');
        const feeInput = document.getElementById('fee');
        const startingDateInput = document.getElementById('startingDate');
        const endingDateInput = document.getElementById('endingDate');
        const reservePeriodInput = document.getElementById('reservePeriod');
        const assignedMembersInput = document.getElementById('assignedMembers');
        const calculatedAmountSpan = document.getElementById('calculatedAmount');

        // Table body for adding/editing rows
        const circlesTableBody = document.getElementById("circlesTableBody");

        // Sponsored Users Section in Popup
        const sponsoredUsersSection = document.getElementById('sponsoredUsersSection');
        const sponsoredUsersList = document.getElementById('sponsoredUsersList');
        const availableSponsoredUsersSelect = document.getElementById('availableSponsoredUsersSelect');
        const addSponsoredUserToCircleBtn = document.getElementById('addSponsoredUserToCircleBtn');


        // --- General Popup Control ---
        function openCirclePopup() {
            addCirclePopupContainer.style.display = 'flex';
            calculateAmount();
            // Show/hide sponsored users section based on edit mode
            sponsoredUsersSection.style.display = isEditingMode ? 'block' : 'none';
        }

        function closeCirclePopup() {
            addCirclePopupContainer.style.display = 'none';
            // Reset form fields and popup state
            circleNameInput.value = '';
            monthlyInvestmentInput.value = '100';
            participantsMonthsInput.value = '10';
            feeInput.value = '';
            startingDateInput.value = '';
            endingDateInput.value = '';
            reservePeriodInput.value = '0';
            assignedMembersInput.value = '0';
            calculatedAmountSpan.textContent = ''; // Clear calculated amount on close
            
            // Clear sponsored users list in popup
            sponsoredUsersList.innerHTML = '<p class="text-gray-500 text-sm">No sponsored users assigned yet.</p>';
            availableSponsoredUsersSelect.innerHTML = '<option value="">Select Sponsored User to Add</option>';


            isEditingMode = false;
            currentCircleBeingEdited = null;
            circlePopupTitle.textContent = 'Add New Circle';
            submitCircleButton.textContent = 'SUBMIT';
        }

        // --- Render Main Circles Table ---
        function renderCirclesTable() {
            circlesTableBody.innerHTML = ''; // Clear existing rows
            circlesData.forEach(circle => {
                const newRow = document.createElement('tr');
                newRow.classList.add('border-b', 'hover:bg-gray-50');

                // Get count of sponsored users assigned to this circle who have met requirements
                const completedSponsoredUsers = circle.sponsoredUsers ? 
                    circle.sponsoredUsers.filter(su => su.completions >= 5 && su.invitesCompleted >= su.requiredInvites).length : 0;
                
                const sponsoredUsersCount = circle.sponsoredUsers ? circle.sponsoredUsers.length : 0;
                
                // Add a class for styling if all sponsored users completed (optional)
                const rowStatusClass = completedSponsoredUsers === sponsoredUsersCount && sponsoredUsersCount > 0 ? 'bg-green-50' : ''; // Light green if all complete

                newRow.innerHTML = `
                    <td class="px-4 py-3 flex space-x-2">
                        <button class="edit-btn" title="Edit" data-circle-id="${circle.id}">‚úèÔ∏è</button>
                        <button class="copy-btn" title="Copy" data-circle-id="${circle.id}">üìã</button>
                    </td>
                    <td class="px-4 py-3">${circle.id}</td>
                    <td class="px-4 py-3">
                        <span class="text-green-700 bg-green-100 px-2 py-1 rounded-full text-xs font-medium">${circle.status}</span>
                    </td>
                    <td class="px-4 py-3">¬£${circle.monthlyInvestment}</td>
                    <td class="px-4 py-3">${circle.participantsMonths}</td>
                    <td class="px-4 py-3">¬£${circle.fee}</td>
                    <td class="px-4 py-3">${circle.startingDate}</td>
                    <td class="px-4 py-3">${circle.endingDate || 'N/A'}</td>
                    <td class="px-4 py-3">${circle.reservePeriod || '0'}</td>
                    <td class="px-4 py-3">${circle.assignedMembersCount || '0'}</td>
                `;
                circlesTableBody.appendChild(newRow);
            });
            saveCirclesToLocalStorage(); // Save changes after rendering
        }


        // --- Add New Circle Logic ---
        addCircleButton.addEventListener('click', () => {
            isEditingMode = false;
            circlePopupTitle.textContent = 'Add New Circle';
            submitCircleButton.textContent = 'SUBMIT';
            closeCirclePopup(); // Ensure form is reset
            openCirclePopup();
        });

        // --- Edit Circle Specific Logic ---
        function openEditCirclePopup(circleId) {
            isEditingMode = true;
            currentCircleBeingEdited = circlesData.find(c => c.id === circleId);

            if (!currentCircleBeingEdited) {
                alert('Error: Circle not found for editing.');
                return;
            }

            circlePopupTitle.textContent = `Edit Circle #${currentCircleBeingEdited.id}`;
            submitCircleButton.textContent = 'SAVE CHANGES';

            // Populate form fields from the circle object
            circleNameInput.value = currentCircleBeingEdited.circleName || '';
            monthlyInvestmentInput.value = currentCircleBeingEdited.monthlyInvestment;
            participantsMonthsInput.value = currentCircleBeingEdited.participantsMonths;
            feeInput.value = currentCircleBeingEdited.fee;
            startingDateInput.value = currentCircleBeingEdited.startingDate;
            endingDateInput.value = currentCircleBeingEdited.endingDate || '';
            reservePeriodInput.value = currentCircleBeingEdited.reservePeriod;
            assignedMembersInput.value = currentCircleBeingEdited.assignedMembersCount;

            // Render sponsored users section
            renderSponsoredUsersInPopup(currentCircleBeingEdited); // Pass the circle object
            populateAvailableSponsoredUsers(currentCircleBeingEdited);

            openCirclePopup();
        }

        // --- Update Existing Circle Logic ---
        function updateExistingCircle() {
            if (!currentCircleBeingEdited) return;

            // Get updated values from form
            const oldCircleName = currentCircleBeingEdited.circleName;
            const oldMonthlyInvestment = currentCircleBeingEdited.monthlyInvestment;
            const oldParticipantsMonths = currentCircleBeingEdited.participantsMonths;
            const oldFee = currentCircleBeingEdited.fee;
            const oldStartingDate = currentCircleBeingEdited.startingDate;
            const oldEndingDate = currentCircleBeingEdited.endingDate;
            const oldReservePeriod = currentCircleBeingEdited.reservePeriod;
            const oldAssignedMembersCount = currentCircleBeingEdited.assignedMembersCount;

            currentCircleBeingEdited.circleName = circleNameInput.value.trim();
            currentCircleBeingEdited.monthlyInvestment = parseFloat(monthlyInvestmentInput.value.trim()) || 0;
            currentCircleBeingEdited.participantsMonths = parseFloat(participantsMonthsInput.value.trim()) || 0;
            currentCircleBeingEdited.fee = parseFloat(feeInput.value.trim()) || 0;
            currentCircleBeingEdited.startingDate = startingDateInput.value.trim();
            currentCircleBeingEdited.endingDate = endingDateInput.value.trim() || null;
            currentCircleBeingEdited.reservePeriod = parseFloat(reservePeriodInput.value.trim()) || 0;
            currentCircleBeingEdited.assignedMembersCount = parseInt(assignedMembersInput.value.trim()) || 0;
            // Status is currently fixed as 'active', but could be made editable
            // currentCircleBeingEdited.status = 'active'; 

            renderCirclesTable(); // Re-render table to show updated data
            alert('Circle updated successfully!');

            // Log the update
            let changes = [];
            if (oldCircleName !== currentCircleBeingEdited.circleName) changes.push(`Name: '${oldCircleName}' -> '${currentCircleBeingEdited.circleName}'`);
            if (oldMonthlyInvestment !== currentCircleBeingEdited.monthlyInvestment) changes.push(`Monthly Inv: ¬£${oldMonthlyInvestment} -> ¬£${currentCircleBeingEdited.monthlyInvestment}`);
            if (oldParticipantsMonths !== currentCircleBeingEdited.participantsMonths) changes.push(`Period: ${oldParticipantsMonths} -> ${currentCircleBeingEdited.participantsMonths}`);
            if (oldFee !== currentCircleBeingEdited.fee) changes.push(`Fee: ¬£${oldFee} -> ¬£${currentCircleBeingEdited.fee}`);
            if (oldStartingDate !== currentCircleBeingEdited.startingDate) changes.push(`Start Date: ${oldStartingDate} -> ${currentCircleBeingEdited.startingDate}`);
            if (oldEndingDate !== currentCircleBeingEdited.endingDate) changes.push(`End Date: ${oldEndingDate || 'N/A'} -> ${currentCircleBeingEdited.endingDate || 'N/A'}`);
            if (oldReservePeriod !== currentCircleBeingEdited.reservePeriod) changes.push(`Reserve Period: ${oldReservePeriod} -> ${currentCircleBeingEdited.reservePeriod}`);
            if (oldAssignedMembersCount !== currentCircleBeingEdited.assignedMembersCount) changes.push(`Assigned Members: ${oldAssignedMembersCount} -> ${currentCircleBeingEdited.assignedMembersCount}`);
            
            if (changes.length > 0) {
                addLogEntry("Circle Updated", `Circle #${currentCircleBeingEdited.id} was updated. Changes: ${changes.join(', ')}.`, { circleId: currentCircleBeingEdited.id, circleName: currentCircleBeingEdited.circleName, updatedFields: changes });
            } else {
                 addLogEntry("Circle Updated", `Circle #${currentCircleBeingEdited.id} was updated (no field changes).`, { circleId: currentCircleBeingEdited.id, circleName: currentCircleBeingEdited.circleName });
            }
        }

        // --- Handle Submission (Add or Edit) ---
        submitCircleButton.addEventListener('click', () => {
            const monthlyInvestment = parseFloat(monthlyInvestmentInput.value.trim());
            const participantsMonths = parseFloat(participantsMonthsInput.value.trim());
            const fee = parseFloat(feeInput.value.trim());
            const startingDate = startingDateInput.value.trim();
            const endingDate = endingDateInput.value.trim();
            const reservePeriod = parseFloat(reservePeriodInput.value.trim()); 
            const assignedMembers = parseInt(assignedMembersInput.value.trim());

            // Basic validation
            if (isNaN(monthlyInvestment) || isNaN(participantsMonths) || isNaN(fee) || !startingDate || isNaN(reservePeriod) || isNaN(assignedMembers)) {
                alert('Please fill in all required fields with valid numbers/dates.');
                return;
            }

            if (isEditingMode) {
                updateExistingCircle();
            } else {
                const newCircle = {
                    id: nextCircleId++,
                    circleName: circleNameInput.value.trim(),
                    monthlyInvestment: monthlyInvestment,
                    participantsMonths: participantsMonths,
                    fee: fee,
                    startingDate: startingDate,
                    endingDate: endingDate || null,
                    reservePeriod: reservePeriod,
                    assignedMembersCount: assignedMembers,
                    status: 'active', // Default status for new circles
                    sponsoredUsers: [] // Initialize empty sponsoredUsers array for new circles
                };
                circlesData.push(newCircle);
                renderCirclesTable();
                alert('New Circle Added!');
                addLogEntry("Circle Created", `New Circle #${newCircle.id} ('${newCircle.circleName || "Unnamed Circle"}') was created.`, { circleId: newCircle.id, circleName: newCircle.circleName });
            }
            closeCirclePopup(); // Close after submission
        });


        // --- Calculation for Amount Display ---
        function calculateAmount() {
            const monthlyInvestment = parseFloat(monthlyInvestmentInput.value) || 0;
            const participantsMonths = parseFloat(participantsMonthsInput.value) || 0;
            const totalAmount = monthlyInvestment * participantsMonths;
            calculatedAmountSpan.textContent = `¬£${monthlyInvestment.toFixed(2)} x ${participantsMonths} = ¬£${totalAmount.toFixed(2)}`;
        }

        // --- Process Financials for a Sponsored User Completion ---
        function processCompletionFinancials(circleId, userId, isInitialLoad = false) {
            const circle = circlesData.find(c => c.id === circleId);
            if (!circle) return;

            const sponsoredUser = circle.sponsoredUsers.find(su => su.userId === userId);
            if (!sponsoredUser) return;

            // 1. Calculate Initial Gift for this single completion
            const giftPerCompletion = circle.monthlyInvestment - circle.fee;

            // 2. Calculate Donation Challenge Contribution (deducted automatically)
            // Example: 10% of monthly investment per completion
            const donationDeductionPerCompletion = circle.monthlyInvestment * DONATION_PERCENTAGE_OF_MONTHLY_INVESTMENT;

            // 3. Calculate Net Gifted Amount (after deduction)
            const netGiftPerCompletion = giftPerCompletion - donationDeductionPerCompletion;

            // 4. Split into categories
            const lockedSavingsPerCompletion = netGiftPerCompletion * LOCKED_SAVINGS_PERCENTAGE;
            const currentAccountPerCompletion = netGiftPerCompletion - lockedSavingsPerCompletion;

            // Update cumulative totals for the sponsored user
            sponsoredUser.totalGiftedAmount = (sponsoredUser.totalGiftedAmount || 0) + giftPerCompletion;
            sponsoredUser.totalDonationDeducted = (sponsoredUser.totalDonationDeducted || 0) + donationDeductionPerCompletion;
            sponsoredUser.totalLockedSavings = (sponsoredUser.totalLockedSavings || 0) + lockedSavingsPerCompletion;
            sponsoredUser.totalCurrentAccount = (sponsoredUser.totalCurrentAccount || 0) + currentAccountPerCompletion;

            // Add transaction to history
            const transactionRecord = {
                date: new Date().toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' }),
                time: new Date().toLocaleTimeString('en-GB'),
                circleId: circle.id,
                completionNumber: sponsoredUser.completions, // This completion
                initialGift: giftPerCompletion.toFixed(2),
                donationDeduction: donationDeductionPerCompletion.toFixed(2),
                netGift: netGiftPerCompletion.toFixed(2),
                lockedSavings: lockedSavingsPerCompletion.toFixed(2),
                currentAccount: currentAccountPerCompletion.toFixed(2)
            };
            // Ensure transactionHistory array exists
            if (!sponsoredUser.transactionHistory) {
                sponsoredUser.transactionHistory = [];
            }
            sponsoredUser.transactionHistory.push(transactionRecord);

            if (!isInitialLoad) { // Only save to local storage and re-render if not initial load
                saveCirclesToLocalStorage();
                renderSponsoredUsersInPopup(circle); // Re-render to show updated display
            }
        }


        // --- Sponsored User Management Logic ---

        // Helper to find a sponsored user by ID in MOCK_USERS_DATA
        function getSponsoredUserFromMock(userId) {
            return MOCK_USERS_DATA.find(u => u.id === userId && u.role === 'Sponsored User');
        }

        // Renders the list of sponsored users in the popup
        function renderSponsoredUsersInPopup(circle) {
            sponsoredUsersList.innerHTML = '';
            if (!circle.sponsoredUsers || circle.sponsoredUsers.length === 0) {
                sponsoredUsersList.innerHTML = '<p class="text-gray-500 text-sm">No sponsored users assigned yet.</p>';
                return;
            }

            circle.sponsoredUsers.forEach(sponsoredUser => {
                const listItem = document.createElement('div');
                listItem.classList.add('sponsored-user-item');
                // Determine if requirements are met for styling
                const completedAll = (sponsoredUser.completions >= 5 && sponsoredUser.invitesCompleted >= sponsoredUser.requiredInvites);
                if(completedAll) {
                    listItem.classList.add('bg-green-50'); // Light green background if completed
                }
                
                listItem.innerHTML = `
                    <span class="main-info">
                        <span class="progress-info">
                            <strong>${sponsoredUser.name}</strong> (ID: ${sponsoredUser.userId}) <br>
                            Completions: ${sponsoredUser.completions}/5 | Invites: ${sponsoredUser.invitesCompleted}/${sponsoredUser.requiredInvites} <br>
                            Total Gifted: ¬£${(sponsoredUser.totalGiftedAmount || 0).toFixed(2)} <br>
                            Donation Deducted: ¬£${(sponsoredUser.totalDonationDeducted || 0).toFixed(2)} <br>
                            Net Gifted (after deduction): ¬£${((sponsoredUser.totalGiftedAmount || 0) - (sponsoredUser.totalDonationDeducted || 0)).toFixed(2)} <br>
                            Locked Savings: ¬£${(sponsoredUser.totalLockedSavings || 0).toFixed(2)} (Locked for 3 months) <br>
                            Current Account Deposit: ¬£${(sponsoredUser.totalCurrentAccount || 0).toFixed(2)}
                        </span>
                        <div class="progress-buttons">
                            <button class="btn-complete" onclick="addCompletion(${circle.id}, '${sponsoredUser.userId}')">Add Completion</button>
                            <button class="btn-invite" onclick="addInvite(${circle.id}, '${sponsoredUser.userId}')">Add Invite</button>
                        </div>
                    </span>
                    <button class="btn-history-toggle" onclick="toggleHistory(this)">Show History</button>
                    <div class="history-section">
                        <h5>Account History for ${sponsoredUser.name}:</h5>
                        <ul class="history-list">
                            ${(sponsoredUser.transactionHistory || []).map(tx => `
                                <li>
                                    [${tx.date} ${tx.time}] Comp #${tx.completionNumber}:<br>
                                    Gift: ¬£${tx.initialGift} | Ded: ¬£${tx.donationDeduction} | Net: ¬£${tx.netGift} <br>
                                    Locked: ¬£${tx.lockedSavings} | Current: ¬£${tx.currentAccount}
                                </li>
                            `).join('')}
                            ${(sponsoredUser.transactionHistory || []).length === 0 ? '<li>No transactions yet.</li>' : ''}
                        </ul>
                    </div>
                `;
                sponsoredUsersList.appendChild(listItem);
            });
        }

        // Toggles the visibility of the history section
        function toggleHistory(button) {
            const historySection = button.nextElementSibling; // Assuming history-section is the next sibling
            if (historySection && historySection.classList.contains('history-section')) {
                const isHidden = historySection.style.display === 'none' || historySection.style.display === '';
                historySection.style.display = isHidden ? 'block' : 'none';
                button.textContent = isHidden ? 'Hide History' : 'Show History';
            }
        }


        // Populates the dropdown with available sponsored users not already in this circle
        function populateAvailableSponsoredUsers(circle) {
            availableSponsoredUsersSelect.innerHTML = '<option value="">Select Sponsored User to Add</option>';
            const assignedSponsoredUserIds = circle.sponsoredUsers.map(su => su.userId);

            MOCK_USERS_DATA.forEach(user => {
                if (user.role === 'Sponsored User' && !assignedSponsoredUserIds.includes(user.id)) {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (ID: ${user.id})`;
                    availableSponsoredUsersSelect.appendChild(option);
                }
            });
        }

        // Logic to add a sponsored user to the current circle being edited
        addSponsoredUserToCircleBtn.addEventListener('click', () => {
            const selectedUserId = availableSponsoredUsersSelect.value;
            if (!selectedUserId || !currentCircleBeingEdited) {
                alert('Please select a sponsored user and ensure a circle is being edited.');
                return;
            }

            const userToAdd = getSponsoredUserFromMock(selectedUserId);
            if (userToAdd) {
                // Check if already added (though select should prevent this)
                const alreadyAssigned = currentCircleBeingEdited.sponsoredUsers.some(su => su.userId === selectedUserId);
                if (alreadyAssigned) {
                    alert('This sponsored user is already assigned to this circle.');
                    return;
                }

                currentCircleBeingEdited.sponsoredUsers.push({
                    userId: userToAdd.id,
                    name: userToAdd.name,
                    completions: 0,
                    invitesCompleted: 0,
                    requiredInvites: 2, // Default requirement
                    notifiedCompletions: false, 
                    notifiedInvites: false,
                    totalGiftedAmount: 0, // Initialize new financial totals
                    totalDonationDeducted: 0,
                    totalLockedSavings: 0,
                    totalCurrentAccount: 0,
                    transactionHistory: [] // Initialize history for new user
                });
                renderSponsoredUsersInPopup(currentCircleBeingEdited); // Re-render the list
                populateAvailableSponsoredUsers(currentCircleBeingEdited); // Update select
                saveCirclesToLocalStorage(); // Save changes
                alert(`${userToAdd.name} added as sponsored user to this circle.`);
                addLogEntry("Sponsored User Assigned", `Sponsored User ${userToAdd.name} (ID: ${userToAdd.id}) assigned to Circle #${currentCircleBeingEdited.id}.`, { userId: userToAdd.id, circleId: currentCircleBeingEdited.id });
            }
        });


        // Increments completion count for a sponsored user in a circle
        function addCompletion(circleId, userId) {
            const circle = circlesData.find(c => c.id === circleId);
            if (!circle) return;

            const sponsoredUser = circle.sponsoredUsers.find(su => su.userId === userId);
            if (sponsoredUser) {
                sponsoredUser.completions++;
                // Process financials and update history
                processCompletionFinancials(circle.id, sponsoredUser.userId); 
                checkSponsoredUserProgress(circleId, userId); // Check for notifications
                // saveCirclesToLocalStorage(); // Already saved by processCompletionFinancials
                addLogEntry("Sponsored User Completion", `Sponsored User ${sponsoredUser.name} (ID: ${sponsoredUser.userId}) completed a turn in Circle #${circle.id}.`, { userId: sponsoredUser.userId, circleId: circle.id, newCompletions: sponsoredUser.completions });
            }
        }

        // Increments invite count for a sponsored user in a circle
        function addInvite(circleId, userId) {
            const circle = circlesData.find(c => c.id === circleId);
            if (!circle) return;

            const sponsoredUser = circle.sponsoredUsers.find(su => su.userId === userId);
            if (sponsoredUser) {
                sponsoredUser.invitesCompleted++;
                renderSponsoredUsersInPopup(circle); // Re-render to show update (no financial changes for invites)
                checkSponsoredUserProgress(circleId, userId); // Check for notifications
                saveCirclesToLocalStorage(); // Save changes
                addLogEntry("Sponsored User Invite", `Sponsored User ${sponsoredUser.name} (ID: ${sponsoredUser.userId}) logged an invite for Circle #${circle.id}.`, { userId: sponsoredUser.userId, circleId: circle.id, newInvites: sponsoredUser.invitesCompleted });
            }
        }

        // Checks if a sponsored user has met their requirements and notifies them
        function checkSponsoredUserProgress(circleId, userId) {
            const circle = circlesData.find(c => c.id === circleId);
            const sponsoredUser = circle ? circle.sponsoredUsers.find(su => su.userId === userId) : null;

            if (sponsoredUser) {
                const completionsMet = sponsoredUser.completions >= 5;
                const invitesMet = sponsoredUser.invitesCompleted >= sponsoredUser.requiredInvites;

                if (completionsMet && !sponsoredUser.notifiedCompletions) {
                    alert(`${sponsoredUser.name} has completed 5 circles in Circle #${circle.id}!`);
                    sponsoredUser.notifiedCompletions = true; // Mark as notified
                }
                if (invitesMet && !sponsoredUser.notifiedInvites) {
                    alert(`${sponsoredUser.name} has invited ${sponsoredUser.requiredInvites} people for Circle #${circle.id}!`);
                    sponsoredUser.notifiedInvites = true; // Mark as notified
                }
                if (completionsMet && invitesMet && !sponsoredUser.notifiedOverall) { // Optional: overall notification
                    alert(`üéâ Congratulations! ${sponsoredUser.name} has completed all requirements for Circle #${circle.id}!`);
                    sponsoredUser.notifiedOverall = true;
                }
            }
            saveCirclesToLocalStorage(); // Save notification status
        }


        // --- Event Delegation for Edit, Copy Buttons in Table ---
        circlesTableBody.addEventListener('click', function(event) {
            const target = event.target;
            const circleId = parseInt(target.dataset.circleId); // Get circle ID from data attribute

            if (target.classList.contains('copy-btn')) {
                const originalCircle = circlesData.find(c => c.id === circleId);
                if (originalCircle) {
                    const newCircle = { ...originalCircle }; // Shallow copy
                    newCircle.id = nextCircleId++; // Assign new ID
                    newCircle.circleName = `${originalCircle.circleName || "Unnamed Circle"} (Copy)`; // Adjust name
                    // Deep copy sponsoredUsers to avoid reference issues, and reset progress for copy
                    newCircle.sponsoredUsers = originalCircle.sponsoredUsers ? 
                        originalCircle.sponsoredUsers.map(su => ({ 
                            userId: su.userId, 
                            name: su.name, 
                            completions: 0, // Reset for copied circle
                            invitesCompleted: 0, // Reset for copied circle
                            requiredInvites: su.requiredInvites,
                            notifiedCompletions: false,
                            notifiedInvites: false,
                            totalGiftedAmount: 0,
                            totalDonationDeducted: 0,
                            totalLockedSavings: 0,
                            totalCurrentAccount: 0,
                            transactionHistory: []
                        })) : [];
                    
                    circlesData.push(newCircle);
                    renderCirclesTable();
                    alert('Circle duplicated!');
                    addLogEntry("Circle Duplicated", `Circle #${originalCircle.id} ('${originalCircle.circleName || "Unnamed Circle"}') was duplicated to new Circle #${newCircle.id}.`, { originalCircleId: originalCircle.id, newCircleId: newCircle.id });
                }
            } else if (target.classList.contains('edit-btn')) { // Only 'edit-btn' now
                isEditingMode = true;
                openEditCirclePopup(circleId);
            }
        });


        // --- Other existing functionalities ---

        // Notification Bell functionality
        const notificationBellAnchor = document.getElementById('notificationBellAnchor');
        const notificationCount = document.getElementById('notificationCount');
        const messageCount = document.getElementById('messageCount');

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCirclesFromLocalStorage(); // Load circles data
            loadTransactionLogFromLocalStorage(); // Load log data (from shared key)
            initializeNextCircleId(); // Initialize ID counter
            renderCirclesTable(); // Initial rendering of the table

            // Optional: Add initial log for circles.html if it's the first page loaded
            // (Only if transactionLog is empty, to avoid duplicates if users.html runs first)
            if (transactionLog.length === 0) { 
                addLogEntry("System Init", "Circles application initialized and created initial sample data.", { currentPage: 'circles.html' });
                saveTransactionLogToLocalStorage();
            }

            if (messageCount) {
                const randomMessages = getRandomInt(1, 9);
                messageCount.textContent = randomMessages;
                messageCount.style.display = randomMessages > 0 ? 'flex' : 'none'; 
            }
            if (notificationCount) {
                const randomNotifications = getRandomInt(0, 9);
                notificationCount.textContent = randomNotifications;
                notificationCount.style.display = randomNotifications > 0 ? 'flex' : 'none'; 
            }
        });


        notificationBellAnchor.addEventListener('click', (e) => {
            e.preventDefault(); 
            e.stopPropagation(); 
            const count = notificationCount.textContent;
            alert(`You have ${count} new notifications!`);
        });

        // Profile Dropdown toggle
        const profileButton = document.getElementById('profileButton');
        const profileDropdown = document.getElementById('profileDropdown');

        profileButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const expanded = profileButton.getAttribute('aria-expanded') === 'true';
            profileButton.setAttribute('aria-expanded', !expanded);
            profileDropdown.style.display = expanded ? 'none' : 'block';
        });

        // Close dropdown if clicking outside
        document.addEventListener('click', (event) => {
            if (profileDropdown && profileButton && !profileButton.contains(event.target) && !profileDropdown.contains(event.target)) {
                profileDropdown.style.display = 'none';
                profileButton.setAttribute('aria-expanded', 'false');
            }
        });
        
        // Inbox Icon functionality
        const inboxIconContainer = document.getElementById('inboxIconContainer');
        inboxIconContainer.addEventListener('click', (e) => {
            // e.preventDefault(); 
            // window.location.href = 'messages.html';
        });


        // Search functionality
        const searchInput = document.getElementById("searchInput");

        searchInput.addEventListener("keyup", function () {
            const query = this.value.toLowerCase();
            const tableRows = circlesTableBody.getElementsByTagName("tr");
            for (let i = 0; i < tableRows.length; i++) {
                const rowText = tableRows[i].innerText.toLowerCase();
                tableRows[i].style.display = rowText.includes(query) ? "" : "none";
            }
        });
    </script>
</body>
</html>