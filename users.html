<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Users</title>
    <link rel="stylesheet" href="styling.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Red badge for notification and message count */
        .badge {
            position: absolute;
            top: 0;
            right: 0;
            transform: translate(50%, -50%);
            background-color: #ef4444; /* Tailwind red-500 */
            color: white;
            border-radius: 9999px;
            width: 1.25rem; /* Slightly larger for numbers up to 99 */
            height: 1.25rem; /* Keep it square for perfect circle */
            font-size: 0.75rem; /* Smaller font for number */
            display: flex; /* Use flexbox for centering text inside */
            align-items: center;
            justify-content: center;
            font-weight: 700; /* Bold number */
            user-select: none; /* Prevent text selection */
            padding: 0.1rem; /* Small padding inside for numbers >= 10 */
            min-width: 1.25rem; /* Ensure minimum width for 1-digit numbers */
            box-sizing: border-box; /* Include padding in width/height */
            z-index: 10; /* Ensure badge is above link text */
        }

        /* Profile dropdown - CORRECTED POSITIONING */
        #profileDropdown {
            display: none;
            position: absolute;
            top: calc(100% + 0.5rem); /* Position below the button with 0.5rem gap */
            left: 0; /* Align to the left edge of the profile link */
            right: auto;
            
            margin-top: 0;
            width: 10rem;
            background-color: white;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
                        0 4px 6px -4px rgb(0 0 0 / 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1050;
        }

        #profileDropdown a {
            display: block;
            padding: 0.5rem 1rem;
            color: #374151; /* gray-700 */
            text-decoration: none;
        }

        #profileDropdown a:hover {
            background-color: #f3f4f6; /* gray-100 */
        }

        /* Layout flex for sidebar and main */
        body {
            display: flex;
            min-height: 100vh;
            background-color: #f3f4f6;
            margin: 0;
        }

        /* Sidebar - MODIFIED FOR FIXED POSITIONING AND FLEX CONTAINER (Consistent with Dashboard) */
        .sidebar {
            background-color: white;
            min-width: 12rem;
            width: 12rem;
            padding: 2rem 1rem;
            box-shadow: 2px 0 6px rgb(0 0 0 / 0.1);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Allow the main navigation list to take up available space */
        }

        .sidebar ul li {
            margin-bottom: 1.25rem;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #374151; /* Tailwind gray-700 */
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
        }

        .sidebar ul li.active a {
            font-weight: 700;
            color: #1e40af; /* Tailwind blue-900 */
        }

        /* Styles for the bottom navigation group (Consistent with Dashboard) */
        .sidebar-bottom-nav {
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
            margin-top: 1.5rem;
            list-style: none;
            padding-left: 0;
            margin-bottom: 0;
        }

        .sidebar-bottom-nav li {
            margin-bottom: 1rem;
            position: relative; /* Needed for badge positioning within the list item */
        }

        .sidebar-bottom-nav li:last-child {
            margin-bottom: 0;
        }

        .sidebar-bottom-nav li a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #374151; /* Tailwind gray-700 */
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem; /* Decreased font size for bottom nav links */
            /* font-style: italic; REMOVED as per request */
            cursor: pointer;
            padding: 0.25rem 0; /* Add slight vertical padding */
            transition: color 0.2s ease; /* Smooth color transition on hover */
        }

        .sidebar-bottom-nav li a:hover {
            color: #1e40af; /* Tailwind blue-900 on hover */
        }

        .sidebar-bottom-nav li.active a {
            font-weight: 700;
            color: #1e40af;
        }

        /* Adjust icon within bottom nav links */
        .sidebar-bottom-nav li a .icon {
            font-size: 1.2rem; /* Slightly smaller icons for bottom nav */
        }

        /* Main content container - MODIFIED TO ACCOUNT FOR FIXED SIDEBAR (Consistent with Dashboard) */
        main.content {
            flex: 1;
            margin-left: 12rem; /* Add margin-left equal to sidebar width */
            padding: 2rem;
            background-color: #f3f4f6; /* Tailwind gray-100 */
            min-height: 100vh;
        }

        /* Additional Users page styles */
        .actions button {
            margin-right: 0.5rem;
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: background-color 0.2s ease-in-out;
            border: none;
        }

        .actions button:hover {
            background-color: #2563eb; /* Tailwind blue-700 */
        }

        .actions button.delete-user-btn {
            background-color: #ef4444; /* Red for delete */
        }

        .actions button.delete-user-btn:hover {
            background-color: #dc2626;
        }

        .pagination {
            margin-top: 1rem;
        }

        .pagination button {
            margin-right: 0.5rem;
            padding: 0.25rem 0.5rem;
            border: 1px solid #cbd5e1; /* Tailwind gray-300 */
            border-radius: 0.375rem;
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .pagination button:disabled {
            background-color: #93c5fd; /* Tailwind blue-300 */
            cursor: default;
        }

        .pagination button:hover:not(:disabled) {
            background-color: #bfdbfe; /* Tailwind blue-200 */
        }

        /* Header controls aligned like dashboard top-bar */
        .header-controls { /* Renamed from header-left for clarity */
            display: flex;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
            background-color: white; /* Consistent with dashboard top-bar */
            padding: 1rem; /* Consistent with dashboard top-bar */
            border-radius: 0.5rem; /* Consistent with dashboard top-bar */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Consistent with dashboard top-bar */
        }

        .header-controls input[type="text"] {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem; /* Adjusted padding for taller input */
            font-size: 0.95rem; /* Slightly larger font */
            outline: none;
            transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
            max-width: 300px; /* Limit max width like dashboard search */
        }

        .header-controls input[type="text"]:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }

        .header-controls button {
            background-color: #1e40af;
            color: white;
            padding: 0.75rem 1.5rem; /* Adjusted padding */
            border-radius: 0.375rem;
            font-size: 0.95rem; /* Slightly larger font */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            border: none;
        }

        .header-controls button:hover {
            background-color: #1e3a8a;
            transform: translateY(-1px);
        }
        .header-controls button:active {
            transform: translateY(0);
        }

        /* Styles for the invite buttons */
        .invite-button {
            background-color: white;
            color: #1e40af;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1.5rem; /* Adjusted padding */
            border-radius: 0.375rem;
            font-size: 0.95rem; /* Adjusted font size */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            white-space: nowrap; /* Prevent text wrapping */
        }

        .invite-button:hover {
            background-color: #f3f4f6;
            border-color: #a0aec0;
            transform: translateY(-1px);
        }
        .invite-button:active {
            transform: translateY(0);
        }

        /* Table styling consistent with Dashboard panels */
        table#usersTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            color: #374151;
            background-color: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Consistent shadow with panels */
            margin-top: 1.5rem; /* Adjusted margin */
        }

        table#usersTable thead {
            background-color: #f9fafb;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
        }

        table#usersTable th,
        table#usersTable td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }

        table#usersTable tbody tr:last-child td {
            border-bottom: none; /* No border on the last row */
        }

        table#usersTable tbody tr:hover {
            background-color: #f3f4f6;
        }

        /* Add/Edit User Pop-up Styles (kept consistent) */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .user-popup {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 25px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            max-height: 90vh; /* Allow scrolling */
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-popup .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .user-popup .popup-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #374151;
            margin: 0;
        }

        .user-popup .popup-header .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #6b7280;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .user-popup .popup-header .close-btn:hover {
            color: #ef4444;
        }

        .user-popup .form-group {
            margin-bottom: 1rem;
        }

        .user-popup .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #4b5563;
            margin-bottom: 5px;
        }

        .user-popup .form-group input,
        .user-popup .form-group select { /* Added select to this rule */
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box;
            color: #374151;
        }

        .user-popup .form-group input:focus,
        .user-popup .form-group select:focus { /* Added select to this rule */
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .user-popup .popup-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        .user-popup .popup-buttons button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .user-popup .popup-buttons .submit-btn {
            background-color: #3b82f6;
            color: white;
        }

        .user-popup .popup-buttons .submit-btn:hover {
            background-color: #2563eb;
        }

        .user-popup .popup-buttons .cancel-btn {
            background-color: #e5e7eb;
            color: #374151;
        }

        .user-popup .popup-buttons .cancel-btn:hover {
            background-color: #d1d5db;
        }

        /* Confirmation Modal Styles (kept consistent) */
        .confirm-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .confirm-modal {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }

        .confirm-modal h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
        }

        .confirm-modal p {
            color: #4b5563;
            margin-bottom: 25px;
        }

        .confirm-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .confirm-modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .confirm-modal-buttons .confirm-yes {
            background-color: #ef4444;
            color: white;
        }

        .confirm-modal-buttons .confirm-yes:hover {
            background-color: #dc2626;
        }

        .confirm-modal-buttons .confirm-no {
            background-color: #e5e7eb;
            color: #374151;
        }

        .confirm-modal-buttons .confirm-no:hover {
            background-color: #d1d5db;
        }
        /* Specific styles for private user options */
        .private-user-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px dashed #d1d5db;
            border-radius: 5px;
            background-color: #f9fafb;
        }
        .private-user-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #4b5563;
            margin-bottom: 0; /* Override form-group margin */
        }
        .private-user-options input[type="checkbox"] {
            width: auto; /* Reset width for checkbox */
            padding: 0;
            margin: 0;
            height: 18px; /* Make checkbox visible */
            width: 18px;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .private-user-options button {
            background-color: #10B981; /* Green for payment */
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease;
            align-self: flex-start; /* Align button to start */
        }
        .private-user-options button:hover {
            background-color: #059669;
        }

        /* Styles for the new Transaction Log Popup */
        .transaction-log-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2500; /* Higher than other popups */
        }
        .transaction-log-popup {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 25px;
            width: 90%;
            max-width: 900px; /* Wider to show log details */
            height: 80vh; /* Fixed height for scrolling */
            display: flex;
            flex-direction: column;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        .transaction-log-popup .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .transaction-log-popup .popup-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #374151;
            margin: 0;
        }
        .transaction-log-popup .popup-header .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #6b7280;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }
        .transaction-log-popup .filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        .transaction-log-popup .filter-controls input,
        .transaction-log-popup .filter-controls select {
            flex: 1;
            min-width: 150px;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .transaction-log-list {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            background-color: #fff;
            padding: 10px;
        }
        .transaction-log-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .transaction-log-list li {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #4b5563;
        }
        .transaction-log-list li:last-child {
            margin-bottom: 0;
        }
        .transaction-log-list li strong {
            color: #374151;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            /* Adjustments for fixed sidebar on small screens */
            .sidebar {
                position: static;
                width: 100%;
                min-width: auto;
                height: auto;
                box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
                padding: 1rem;
            }
            .sidebar ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 1rem;
                flex-grow: 0;
            }
            .sidebar ul li {
                margin-bottom: 0;
            }
            .sidebar ul li a {
                font-size: 0.9rem;
                gap: 0.25rem;
            }
            /* Bottom nav also becomes horizontal on mobile */
            .sidebar-bottom-nav {
                flex-direction: row;
                justify-content: center;
                gap: 1rem;
                margin-top: 1rem;
                border-top: none;
                padding-top: 0;
            }
            .sidebar-bottom-nav li {
                margin-bottom: 0;
            }

            main.content {
                margin-left: 0;
                padding: 1rem;
            }
            .header-controls {
                flex-direction: column; /* Stack controls vertically on small screens */
                align-items: stretch; /* Stretch items */
                gap: 0.75rem; /* Adjust gap */
            }
            .header-controls input[type="text"] {
                max-width: none;
            }
            .dashboard-panel { /* This class is not directly on this page, but keeping here as a placeholder for consistency */
                padding: 1.5rem;
            }
            .transaction-log-popup {
                height: 90vh; /* Adjust height for mobile */
                max-width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-logo mb-8 mt-2 text-center">
            <a href="dashboard.html">
                <img src="Images/logo.png" alt="UNOCIRCLE Logo" class="h-12 w-auto mx-auto object-contain">
            </a>
        </div>

        <ul>
            <li><a href="dashboard.html"><i class="icon">🏁</i><span>Dashboard</span></a></li>
            <li class="active"><a href="users.html"><i class="icon">👤</i><span>Users</span></a></li>
            <li><a href="circles.html"><i class="icon">⚪</i><span>Circles</span></a></li>
            <li><a href="circle-tracker.html"><i class="icon">📊</i><span>Circle Tracker</span></a></li>
            <li><a href="payments.html"><i class="icon">💵</i><span>Payments</span></a></li>
            <li><a href="admin_users.html"><i class="icon">👑</i><span>Admin</span></a></li>
        </ul>

        <ul class="sidebar-bottom-nav">
            <li>
                <a href="messages.html" id="inboxIconContainer">
                    <i class="icon">✉️</i><span>Messages</span>
                    <span class="badge" id="messageCount">0</span> </a>
            </li>
            <li>
                <a href="#" id="notificationBellAnchor">
                    <i class="icon">🔔</i><span>Notifications</span>
                    <span class="badge" id="notificationCount">0</span> </a>
            </li>
            <li id="profileMenuContainer">
                <a href="#" id="profileButton" aria-haspopup="true" aria-expanded="false" aria-controls="profileDropdown"><i class="icon">👤</i><span>Profile</span></a>
                <div id="profileDropdown" role="menu" aria-label="Profile Options">
                    <a href="account.html" role="menuitem" tabindex="-1">My Account</a>
                    <a href="login.html" role="menuitem" tabindex="-1">Log Out</a>
                </div>
            </li>
        </ul>
    </div>

    <main class="content">
        <h1 class="text-2xl font-semibold text-gray-800 mb-6">Users</h1>
        <h2 class="text-lg font-medium text-gray-700 mb-4">Manage Users</h2>

        <div class="header-controls">
            <input id="searchUser" type="text" placeholder="Search users..." />
            <button id="addUserButton">Add User</button>
            <button id="inviteCirclesButton" class="invite-button">INVITE USERS<br>IN CIRCLES</button>
            <button id="inviteWithoutCirclesButton" class="invite-button">INVITE USERS<br>W/O CIRCLES</button>
            <button id="viewTransactionLogBtn" class="invite-button">VIEW TRANSACTION LOG</button> </div>

        <table id="usersTable" aria-label="Users table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                </tbody>
        </table>

        <div class="pagination">
            <button disabled>&laquo; Prev</button>
            <button>Next &raquo;</button>
        </div>
    </main>

    <div class="popup-overlay" id="userPopupContainer">
        <div class="user-popup">
            <div class="popup-header">
                <h3 id="userPopupTitle">Add New User</h3>
                <button class="close-btn" onclick="closeUserPopup()">×</button>
            </div>
            <form id="userForm">
                <div class="form-group">
                    <label for="userName">Name:</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Email:</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label for="userRole">Role:</label>
                    <select id="userRole" required>
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                        <option value="Sponsored User">Sponsored User</option>
                        <option value="System Admin">System Admin</option>
                        <option value="Private User">Private User</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userStatus">Status:</label>
                    <input type="text" id="userStatus" required>
                </div>

                <div id="privateUserOptions" class="private-user-options" style="display: none;">
                    <h4>Private User Options:</h4>
                    <label>
                        <input type="checkbox" id="donatesToChallengeOptOut">
                        Opt out of 52-week Donation Challenge
                    </label>
                    <p class="text-sm">Payment status for Circle #18: <span id="circle18PaymentStatus">Not Paid</span></p>
                    <button type="button" id="markCircle18PaidBtn">Mark Payment for Circle #18</button>
                    <p class="text-xs text-gray-500 mt-2">
                        <em>(In a real system, payment status would be per-circle per-user and handled via payment gateway)</em>
                    </p>
                </div>

                <div class="popup-buttons">
                    <button type="submit" class="submit-btn" id="submitUserButton">Add User</button>
                    <button type="button" class="cancel-btn" onclick="closeUserPopup()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="confirm-modal-overlay" id="confirmDeleteModal">
        <div class="confirm-modal">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete this user?</p>
            <div class="confirm-modal-buttons">
                <button class="confirm-yes" id="confirmDeleteYes">Yes, Delete</button>
                <button class="confirm-no" id="confirmDeleteNo">No, Cancel</button>
            </div>
        </div>
    </div>

    <div class="transaction-log-popup-overlay" id="transactionLogPopupContainer">
        <div class="transaction-log-popup">
            <div class="popup-header">
                <h3>Transaction History Log</h3>
                <button class="close-btn" onclick="closeTransactionLogPopup()">×</button>
            </div>
            <div class="filter-controls">
                <input type="date" id="logFilterStartDate" title="Filter by Start Date">
                <input type="date" id="logFilterEndDate" title="Filter by End Date">
                <select id="logFilterActivityType" title="Filter by Activity Type">
                    <option value="">All Activity Types</option>
                    <option value="User Created">User Created</option>
                    <option value="User Updated">User Updated</option>
                    <option value="User Deleted">User Deleted</option>
                    <option value="Circle Payment Marked">Circle Payment Marked</option>
                    <option value="Circle Created">Circle Created</option>
                    <option value="Circle Updated">Circle Updated</option>
                    <option value="Circle Duplicated">Circle Duplicated</option>
                    <option value="Sponsored User Assigned">Sponsored User Assigned</option>
                    <option value="Sponsored User Completion">Sponsored User Completion</option>
                    <option value="Sponsored User Invite">Sponsored User Invite</option>
                    </select>
                <button id="applyLogFiltersBtn" class="bg-blue-500 text-white px-3 py-2 rounded">Apply Filters</button>
                <button id="clearLogFiltersBtn" class="bg-gray-400 text-white px-3 py-2 rounded">Clear Filters</button>
            </div>
            <div class="transaction-log-list">
                <ul id="logList">
                    </ul>
                <p id="noLogEntriesMessage" style="display: none; text-align: center; color: #6b7280;">No log entries found for the selected filters.</p>
            </div>
        </div>
    </div>


    <script>
        // --- DATA STORAGE AND INITIALIZATION ---
        let usersData = []; 
        let transactionLog = []; // Global array for all transactions/activities

        const LOCAL_STORAGE_USERS_KEY = 'usersApp_usersData';
        const LOCAL_STORAGE_LOG_KEY = 'app_transactionLog'; // Separate key for the log

        // Mock Current User for logging purposes (adjust as needed for testing roles)
        const CURRENT_USER_ID = '001'; // Assuming Alice Smith is currently logged in
        const CURRENT_USER_NAME = 'Alice Smith'; // Or dynamically set based on role

        // --- Local Storage Functions for Users Data ---
        function loadUsersFromLocalStorage() {
            const storedData = localStorage.getItem(LOCAL_STORAGE_USERS_KEY);
            if (storedData) {
                usersData = JSON.parse(storedData);
            } else {
                usersData = [
                    { id: '001', name: 'Alice Smith', email: 'alice@example.com', role: 'Admin', status: 'Active', donatesToChallenge: true, circlePayments: {} },
                    { id: '002', name: 'Bob Johnson', email: 'bob@example.com', role: 'User', status: 'Inactive', donatesToChallenge: true, circlePayments: {} },
                    { id: '003', name: 'Charlie Brown', email: 'charlie@example.com', role: 'Sponsored User', status: 'Active', donatesToChallenge: false, circlePayments: {} }, 
                    { id: '004', name: 'David Miller', email: 'david@example.com', role: 'System Admin', status: 'Active', donatesToChallenge: true, circlePayments: {} },
                    { id: '005', name: 'Emily White', email: 'emily@example.com', role: 'Private User', status: 'Active', donatesToChallenge: false, circlePayments: {'18': {isPaid: false, paymentDate: null}} } 
                ];
                saveUsersToLocalStorage(); 
            }
        }

        function saveUsersToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_USERS_KEY, JSON.stringify(usersData));
        }

        // --- Local Storage Functions for Transaction Log (NEW) ---
        function loadTransactionLogFromLocalStorage() {
            const storedLog = localStorage.getItem(LOCAL_STORAGE_LOG_KEY);
            if (storedLog) {
                transactionLog = JSON.parse(storedLog);
            } else {
                transactionLog = []; // Empty log on first load
            }
        }

        function saveTransactionLogToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_LOG_KEY, JSON.stringify(transactionLog));
        }

        // --- Helper to get the next sequential user ID ---
        function getNextUserId() {
            let maxId = 0;
            if (usersData.length > 0) {
                maxId = Math.max(...usersData.map(user => parseInt(user.id, 10)));
            }
            return (maxId + 1).toString().padStart(3, '0');
        }

        // --- Add Log Entry Function (NEW - IMPORTANT FOR BOTH PAGES) ---
        function addLogEntry(type, description, details = {}) {
            const now = new Date();
            const timestamp = now.toISOString(); // ISO string for easy date comparison
            const readableDate = now.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' });
            const readableTime = now.toLocaleTimeString('en-GB');

            const entry = {
                timestamp: timestamp,
                date: readableDate,
                time: readableTime,
                type: type, // e.g., "User Created", "Circle Updated", "Payment Marked"
                description: description,
                actorId: CURRENT_USER_ID,
                actorName: CURRENT_USER_NAME,
                details: details // Any additional data relevant to the log
            };
            transactionLog.push(entry);
            saveTransactionLogToLocalStorage();
        }


        // --- Get references to DOM elements ---
        const usersTableBody = document.getElementById('usersTableBody');
        const addUserButton = document.getElementById('addUserButton');
        const searchUserInput = document.getElementById('searchUser');
        const viewTransactionLogBtn = document.getElementById('viewTransactionLogBtn'); // NEW

        // User Pop-up elements
        const userPopupContainer = document.getElementById('userPopupContainer');
        const userPopupTitle = document.getElementById('userPopupTitle');
        const userForm = document.getElementById('userForm');
        const submitUserButton = document.getElementById('submitUserButton');
        const userNameInput = document.getElementById('userName');
        const userEmailInput = document.getElementById('userEmail');
        const userRoleSelect = document.getElementById('userRole'); 
        const userStatusInput = document.getElementById('userStatus');

        // Private User specific elements
        const privateUserOptions = document.getElementById('privateUserOptions');
        const donatesToChallengeOptOut = document.getElementById('donatesToChallengeOptOut');
        const circle18PaymentStatus = document.getElementById('circle18PaymentStatus');
        const markCircle18PaidBtn = document.getElementById('markCircle18PaidBtn');

        // Confirmation Modal elements
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const confirmDeleteYesButton = document.getElementById('confirmDeleteYes');
        const confirmDeleteNoButton = document.getElementById('confirmDeleteNo');
        let userIdToDelete = null; 

        // Transaction Log Popup elements (NEW)
        const transactionLogPopupContainer = document.getElementById('transactionLogPopupContainer');
        const logFilterStartDate = document.getElementById('logFilterStartDate');
        const logFilterEndDate = document.getElementById('logFilterEndDate');
        const logFilterActivityType = document.getElementById('logFilterActivityType');
        const applyLogFiltersBtn = document.getElementById('applyLogFiltersBtn');
        const clearLogFiltersBtn = document.getElementById('clearLogFiltersBtn');
        const logList = document.getElementById('logList');
        const noLogEntriesMessage = document.getElementById('noLogEntriesMessage');


        // --- Render Users Table ---
        function renderUsersTable() {
            usersTableBody.innerHTML = ''; 
            usersData.forEach(user => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>${user.status}</td>
                    <td class="actions">
                        <button class="edit-user-btn" data-user-id="${user.id}">Edit</button>
                        <button class="delete-user-btn" data-user-id="${user.id}">Delete</button>
                    </td>
                `;
                usersTableBody.appendChild(newRow);
            });
            saveUsersToLocalStorage(); 
        }


        // --- User Pop-up Control Functions ---
        function openUserPopup() {
            userPopupContainer.style.display = 'flex';
        }

        function closeUserPopup() {
            userPopupContainer.style.display = 'none';
            userForm.reset();
            privateUserOptions.style.display = 'none';
            isEditingUserMode = false;
            currentRowBeingEdited = null;
            userPopupTitle.textContent = 'Add New User';
            submitUserButton.textContent = 'Add User';
        }

        // --- Add User Logic ---
        addUserButton.addEventListener('click', () => {
            isEditingUserMode = false;
            userPopupTitle.textContent = 'Add New User';
            submitUserButton.textContent = 'Add User';
            closeUserPopup(); 
            openUserPopup();
        });

        function createNewUser(name, email, role, status, donatesToChallenge, circlePayments) {
            const newUser = {
                id: getNextUserId(),
                name: name,
                email: email,
                role: role,
                status: status,
                donatesToChallenge: donatesToChallenge,
                circlePayments: circlePayments
            };
            usersData.push(newUser);
            renderUsersTable(); 
            alert('New user added successfully!');
            addLogEntry("User Created", `User ${name} (ID: ${newUser.id}) with role '${role}' was created.`, { userId: newUser.id, userName: name, role: role });
        }

        // --- Edit User Logic ---
        function openEditUserPopup(userId) {
            isEditingUserMode = true;
            const userToEdit = usersData.find(user => user.id === userId);
            currentRowBeingEdited = usersTableBody.querySelector(`button[data-user-id="${userId}"]`).closest('tr');

            if (!userToEdit) {
                alert('User not found for editing.');
                return;
            }

            userPopupTitle.textContent = `Edit User (${userToEdit.id})`;
            submitUserButton.textContent = 'Save Changes';

            userNameInput.value = userToEdit.name;
            userEmailInput.value = userToEdit.email;
            userRoleSelect.value = userToEdit.role;
            userStatusInput.value = userToEdit.status;

            // Handle Private User specific options
            if (userToEdit.role === 'Private User') {
                privateUserOptions.style.display = 'block';
                donatesToChallengeOptOut.checked = !userToEdit.donatesToChallenge; 
                
                const paymentStatus = userToEdit.circlePayments['18']?.isPaid ? 'Paid' : 'Not Paid';
                circle18PaymentStatus.textContent = paymentStatus;
                markCircle18PaidBtn.textContent = userToEdit.circlePayments['18']?.isPaid ? 'Mark Not Paid' : 'Mark Payment for Circle #18';
            } else {
                privateUserOptions.style.display = 'none';
            }

            openUserPopup();
        }

        function updateExistingUser(name, email, role, status, donatesToChallenge, circlePayments) {
            if (!currentRowBeingEdited) return; 

            const userId = currentRowBeingEdited.querySelector('td').textContent; 
            const userIndex = usersData.findIndex(user => user.id === userId);

            if (userIndex !== -1) {
                const oldUser = { ...usersData[userIndex] }; // Copy for logging changes
                usersData[userIndex].name = name;
                usersData[userIndex].email = email;
                usersData[userIndex].role = role;
                usersData[userIndex].status = status;
                usersData[userIndex].donatesToChallenge = donatesToChallenge;
                usersData[userIndex].circlePayments = circlePayments; 

                renderUsersTable(); 
                alert('User updated successfully!');
                
                // Detailed logging for user update
                let changes = [];
                if (oldUser.name !== name) changes.push(`Name: '${oldUser.name}' -> '${name}'`);
                if (oldUser.email !== email) changes.push(`Email: '${oldUser.email}' -> '${email}'`);
                if (oldUser.role !== role) changes.push(`Role: '${oldUser.role}' -> '${role}'`);
                if (oldUser.status !== status) changes.push(`Status: '${oldUser.status}' -> '${status}'`);
                if (oldUser.donatesToChallenge !== donatesToChallenge) changes.push(`Donation Challenge Opt-out: '${!oldUser.donatesToChallenge}' -> '${!donatesToChallenge}'`);

                addLogEntry("User Updated", `User ${name} (ID: ${userId}) was updated. Changes: ${changes.join(', ')}`, { userId: userId, changes: changes });
            }
        }

        // Listener for Role select change (to show/hide private user options)
        userRoleSelect.addEventListener('change', () => {
            if (userRoleSelect.value === 'Private User') {
                privateUserOptions.style.display = 'block';
                donatesToChallengeOptOut.checked = true; // Default to opting out
                circle18PaymentStatus.textContent = 'Not Paid';
                markCircle18PaidBtn.textContent = 'Mark Payment for Circle #18';
            } else {
                privateUserOptions.style.display = 'none';
            }
        });

        // Event listener for Mark Payment button (for Circle #18)
        markCircle18PaidBtn.addEventListener('click', () => {
            const userId = currentRowBeingEdited.querySelector('td').textContent;
            const user = usersData.find(u => u.id === userId);

            if (user && user.role === 'Private User') {
                const currentStatus = user.circlePayments['18']?.isPaid;
                const newStatus = !currentStatus;
                user.circlePayments['18'] = {
                    isPaid: newStatus,
                    paymentDate: newStatus ? new Date().toISOString() : null
                };
                circle18PaymentStatus.textContent = newStatus ? 'Paid' : 'Not Paid';
                markCircle18PaidBtn.textContent = newStatus ? 'Mark Not Paid' : 'Mark Payment for Circle #18';
                
                alert(`Payment status for Circle #18 updated to: ${newStatus ? 'Paid' : 'Not Paid'}`);
                saveUsersToLocalStorage(); 
                addLogEntry("Circle Payment Marked", `Payment for Circle #18 marked as '${newStatus ? 'Paid' : 'Not Paid'}' for Private User ${user.name} (ID: ${user.id}).`, { userId: user.id, circleId: '18', paymentStatus: newStatus });
            }
        });


        // --- Handle User Form Submission (Add or Edit) ---
        userForm.addEventListener('submit', function(event) {
            event.preventDefault(); 

            const name = userNameInput.value.trim();
            const email = userEmailInput.value.trim();
            const role = userRoleSelect.value;
            const status = userStatusInput.value.trim();

            let donatesToChallenge = true; 
            let circlePayments = {};

            if (role === 'Private User') {
                donatesToChallenge = !donatesToChallengeOptOut.checked; 
                circlePayments = { // Initialize for sample circle 18
                    '18': { isPaid: false, paymentDate: null }
                };
            } else if (role === 'Sponsored User') {
                donatesToChallenge = false; 
            }

            if (isEditingUserMode) {
                const userId = currentRowBeingEdited.querySelector('td').textContent;
                const existingUser = usersData.find(u => u.id === userId);
                if (existingUser) {
                    circlePayments = existingUser.circlePayments; // Preserve existing
                    if (role === 'Private User' && !circlePayments['18']) {
                        circlePayments['18'] = {isPaid: false, paymentDate: null};
                    }
                }
                updateExistingUser(name, email, role, status, donatesToChallenge, circlePayments);
            } else {
                createNewUser(name, email, role, status, donatesToChallenge, circlePayments);
            }
            closeUserPopup();
        });

        // --- Delete User Logic (with Confirmation Modal) ---
        function showConfirmDeleteModal(id) {
            userIdToDelete = id; 
            confirmDeleteModal.style.display = 'flex';
        }

        function hideConfirmDeleteModal() {
            confirmDeleteModal.style.display = 'none';
            userIdToDelete = null;
        }

        confirmDeleteYesButton.addEventListener('click', () => {
            if (userIdToDelete) {
                const userIndex = usersData.findIndex(user => user.id === userIdToDelete);
                if (userIndex !== -1) {
                    const deletedUser = usersData[userIndex]; // Get user for logging
                    usersData.splice(userIndex, 1); 
                    renderUsersTable(); 
                    alert('User deleted successfully!');
                    addLogEntry("User Deleted", `User ${deletedUser.name} (ID: ${deletedUser.id}) with role '${deletedUser.role}' was deleted.`, { userId: deletedUser.id, userName: deletedUser.name });
                }
            }
            hideConfirmDeleteModal();
        });

        confirmDeleteNoButton.addEventListener('click', () => {
            hideConfirmDeleteModal();
        });


        // --- Event Delegation for Edit and Delete Buttons in Table ---
        usersTableBody.addEventListener('click', function(event) {
            const target = event.target;
            const userId = target.dataset.userId; 

            if (target.classList.contains('edit-user-btn')) {
                if (userId) {
                    openEditUserPopup(userId); 
                }
            } else if (target.classList.contains('delete-user-btn')) {
                if (userId) {
                    showConfirmDeleteModal(userId); 
                }
            }
        });

        // --- Search Functionality ---
        searchUserInput.addEventListener('keyup', function() {
            const query = this.value.toLowerCase();
            const rows = usersTableBody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const rowText = row.textContent.toLowerCase();
                if (rowText.includes(query)) {
                    row.style.display = ''; 
                } else {
                    row.style.display = 'none'; 
                }
            }
        });

        // --- Transaction Log Popup Logic (NEW) ---

        viewTransactionLogBtn.addEventListener('click', () => {
            openTransactionLogPopup();
        });

        function openTransactionLogPopup() {
            transactionLogPopupContainer.style.display = 'flex';
            renderTransactionLog(); // Render all logs on open
        }

        function closeTransactionLogPopup() {
            transactionLogPopupContainer.style.display = 'none';
            // Clear filters when closing
            logFilterStartDate.value = '';
            logFilterEndDate.value = '';
            logFilterActivityType.value = '';
        }

        applyLogFiltersBtn.addEventListener('click', () => {
            renderTransactionLog(); // Apply filters by re-rendering
        });

        clearLogFiltersBtn.addEventListener('click', () => {
            logFilterStartDate.value = '';
            logFilterEndDate.value = '';
            logFilterActivityType.value = '';
            renderTransactionLog(); // Clear filters and re-render
        });

        function renderTransactionLog() {
            logList.innerHTML = ''; // Clear existing log entries
            let filteredLog = [...transactionLog].reverse(); // Get a copy and reverse for newest first

            const startDate = logFilterStartDate.value ? new Date(logFilterStartDate.value) : null;
            const endDate = logFilterEndDate.value ? new Date(logFilterEndDate.value) : null;
            const activityType = logFilterActivityType.value;

            if (startDate) {
                // Set time to start of day for accurate comparison
                startDate.setHours(0, 0, 0, 0); 
            }
            if (endDate) {
                // Set time to end of day for accurate comparison
                endDate.setHours(23, 59, 59, 999);
            }

            filteredLog = filteredLog.filter(entry => {
                const entryDate = new Date(entry.timestamp);

                // Filter by date range
                if (startDate && entryDate < startDate) return false;
                if (endDate && entryDate > endDate) return false;

                // Filter by activity type
                if (activityType && entry.type !== activityType) return false;

                return true;
            });

            if (filteredLog.length === 0) {
                noLogEntriesMessage.style.display = 'block';
            } else {
                noLogEntriesMessage.style.display = 'none';
                filteredLog.forEach(entry => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <strong>[${entry.date} ${entry.time}]</strong> 
                        <span class="text-blue-700 font-semibold">${entry.type}</span> by ${entry.actorName} (ID: ${entry.actorId})<br>
                        ${entry.description}
                    `;
                    logList.appendChild(listItem);
                });
            }
        }


        // --- Other existing functionalities (Profile Dropdown, Notification Bell, Inbox Icon) ---

        // Notification Bell functionality
        const notificationBellAnchor = document.getElementById('notificationBellAnchor');
        const notificationCount = document.getElementById('notificationCount');
        const messageCount = document.getElementById('messageCount'); 

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadUsersFromLocalStorage(); // Load users data
            loadTransactionLogFromLocalStorage(); // Load log data
            renderUsersTable(); // Initial render of users table

            // Initial log entries if starting fresh (for demo purposes)
            if (transactionLog.length === 0) {
                addLogEntry("System Init", "Application initialized.", { currentPage: 'users.html' });
                addLogEntry("User Created", "Sample user Alice Smith (ID: 001) with role 'Admin' was pre-created.", { userId: '001', userName: 'Alice Smith', role: 'Admin' });
                addLogEntry("User Created", "Sample user Bob Johnson (ID: 002) with role 'User' was pre-created.", { userId: '002', userName: 'Bob Johnson', role: 'User' });
                addLogEntry("User Created", "Sample user Charlie Brown (ID: 003) with role 'Sponsored User' was pre-created.", { userId: '003', userName: 'Charlie Brown', role: 'Sponsored User' });
                addLogEntry("User Created", "Sample user David Miller (ID: 004) with role 'System Admin' was pre-created.", { userId: '004', userName: 'David Miller', role: 'System Admin' });
                addLogEntry("User Created", "Sample user Emily White (ID: 005) with role 'Private User' was pre-created.", { userId: '005', userName: 'Emily White', role: 'Private User' });
                saveTransactionLogToLocalStorage(); // Save these initial logs
            }


            if (messageCount) {
                const randomMessages = getRandomInt(1, 9); 
                messageCount.textContent = randomMessages;
                messageCount.style.display = randomMessages > 0 ? 'flex' : 'none'; 
            }
            if (notificationCount) {
                const randomNotifications = getRandomInt(0, 9); 
                notificationCount.textContent = randomNotifications;
                notificationCount.style.display = randomNotifications > 0 ? 'flex' : 'none'; 
            }
        });


        notificationBellAnchor.addEventListener('click', (e) => {
            e.preventDefault(); 
            e.stopPropagation(); 
            const count = notificationCount.textContent;
            alert(`You have ${count} new notifications!`);
        });

        // Profile Dropdown toggle
        const profileButton = document.getElementById('profileButton');
        const profileDropdown = document.getElementById('profileDropdown');

        profileButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const expanded = profileButton.getAttribute('aria-expanded') === 'true';
            profileButton.setAttribute('aria-expanded', !expanded);
            profileDropdown.style.display = expanded ? 'none' : 'block';
        });

        // Close dropdown if clicking outside
        document.addEventListener('click', (event) => {
            if (profileDropdown && profileButton && !profileButton.contains(event.target) && !profileDropdown.contains(event.target)) {
                profileDropdown.style.display = 'none';
                profileButton.setAttribute('aria-expanded', 'false');
            }
        });
        
        // Inbox Icon functionality
        const inboxIconContainer = document.getElementById('inboxIconContainer');
        inboxIconContainer.addEventListener('click', (e) => {
            // e.preventDefault(); 
            // window.location.href = 'messages.html';
        });

        // NEW: Invite Buttons Functionality
        const inviteCirclesButton = document.getElementById('inviteCirclesButton');
        const inviteWithoutCirclesButton = document.getElementById('inviteWithoutCirclesButton');

        inviteCirclesButton.addEventListener('click', () => {
            alert('Initiating invitation process for users IN circles.');
            addLogEntry("Invitation Initiated", "Invitation process initiated for users in circles.", { type: "In Circles" });
        });

        inviteWithoutCirclesButton.addEventListener('click', () => {
            alert('Initiating invitation process for users WITHOUT circles.');
            addLogEntry("Invitation Initiated", "Invitation process initiated for users without circles.", { type: "Without Circles" });
        });
    </script>
</body>
</html>